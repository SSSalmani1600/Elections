variables:
  DEPLOY_MKDOCS: "true"
  DEPLOY_HIC: "true"
  VITE_API_URL: "http://oege.ie.hva.nl:9000"

stages:
  - build
  - test
  - package
  - deploy

include:
  - ".gitlab-ci.mkdocs.yml"

# Backend Build
build-backend:
  stage: build
  image: maven:3.9.4-eclipse-temurin-21
  tags:
    - hva
  script:
    - cd election-backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - election-backend/target/*.jar
    expire_in: 1 hour

# Frontend Build
build-frontend:
  stage: build
  image: node:22-alpine
  tags:
    - hva
  script:
    - cd election-frontend
    - npm install --legacy-peer-deps
    - npm run build
  artifacts:
    paths:
      - election-frontend/dist/
    expire_in: 1 hour

# Backend Tests
test-backend:
  stage: test
  image: maven:3.9.4-eclipse-temurin-21
  tags:
    - hva
  script:
    - cd election-backend
    - mvn test
  allow_failure: true

# Frontend Lint & Type-check
test-frontend:
  stage: test
  image: node:22-alpine
  tags:
    - hva
  script:
    - cd election-frontend
    - npm ci
    - npm run type-check
    - npm run lint || true # Maak de pipeline niet rood op linting-fouten
  allow_failure: true

# Docker Build and Push to Registry using Kaniko (required for HvA runners)
docker-package:
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  tags:
    - hva
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "$CI_REGISTRY_USER" "$CI_REGISTRY_PASSWORD" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    # Build Backend
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/election-backend"
      --dockerfile "${CI_PROJECT_DIR}/election-backend/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}/backend:latest"
    # Build Frontend
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/election-frontend"
      --dockerfile "${CI_PROJECT_DIR}/election-frontend/Dockerfile"
      --build-arg VITE_API_URL=$VITE_API_URL
      --destination "${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}/frontend:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deployment to HIC (Oege)
# To use this, you need to set SSH_USER, SSH_HOST, and SSH_PRIVATE_KEY in GitLab CI/CD Variables
deploy-hic:
  stage: deploy
  image: ubuntu:latest
  tags:
    - hva
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get update -y && apt-get install -y openssh-client
  script:
    - echo "Deploying to HIC server (oege.ie.hva.nl)..."
    - |
      if [ -n "$SSH_PRIVATE_KEY" ]; then
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Write key to file and clean it aggressively
        if [ -f "$SSH_PRIVATE_KEY" ]; then
          cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
        else
          # Remove Windows line endings and write to file
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        fi
        
        # Remove any trailing whitespace from each line (common cause of libcrypto error)
        sed -i 's/[[:space:]]*$//' ~/.ssh/id_rsa
        # Ensure exactly one newline at the end
        sed -i -e '$a\' ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        eval $(ssh-agent -s)
        ssh-add ~/.ssh/id_rsa
        ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
        
        # Create .env file for production on the server (in user's home directory)
        ssh $SSH_USER@$SSH_HOST "mkdir -p ~/app"
        ssh $SSH_USER@$SSH_HOST "printf 'SPRING_DATASOURCE_URL=%s\nSPRING_DATASOURCE_USERNAME=%s\nSPRING_DATASOURCE_PASSWORD=%s\nJWT_SECRET_B64=%s\nGEMINI_API_KEY=%s\nCI_REGISTRY_IMAGE=%s\n' '$SPRING_DATASOURCE_URL' '$SPRING_DATASOURCE_USERNAME' '$SPRING_DATASOURCE_PASSWORD' '$JWT_SECRET_B64' '$GEMINI_API_KEY' '$CI_REGISTRY_IMAGE' > ~/app/.env"
        
        # Copy production docker-compose file
        scp docker-compose.prod.yml $SSH_USER@$SSH_HOST:~/app/docker-compose.yml
        
        # Log in on registry and restart containers
        ssh $SSH_USER@$SSH_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY && cd ~/app && docker compose pull && docker compose up -d"
      else
        echo "SSH_PRIVATE_KEY niet set, overslaan van feitelijke deployment."
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $DEPLOY_HIC == "true"
