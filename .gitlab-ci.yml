variables:
  DEPLOY_MKDOCS: "true"
  DEPLOY_HIC: "true"
  VITE_API_URL: "http://oege.ie.hva.nl:9000"

stages:
  - build
  - test
  - package
  - deploy

include:
  - ".gitlab-ci.mkdocs.yml"

# Backend Build
build-backend:
  stage: build
  image: maven:3.9.4-eclipse-temurin-21
  tags:
    - hva
  script:
    - cd election-backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - election-backend/target/*.jar
    expire_in: 1 hour

# Frontend Build
build-frontend:
  stage: build
  image: node:22-alpine
  tags:
    - hva
  script:
    - cd election-frontend
    - npm install --legacy-peer-deps
    - npm run build
  artifacts:
    paths:
      - election-frontend/dist/
    expire_in: 1 hour

# Backend Tests
test-backend:
  stage: test
  image: maven:3.9.4-eclipse-temurin-21
  tags:
    - hva
  script:
    - cd election-backend
    - mvn test
  allow_failure: true

# Frontend Lint & Type-check
test-frontend:
  stage: test
  image: node:22-alpine
  tags:
    - hva
  script:
    - cd election-frontend
    - npm ci
    - npm run type-check
    - npm run lint
  allow_failure: true

# Docker Build and Push to Registry
docker-package:
  stage: package
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  tags:
    - hva
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA ./election-backend
    - docker build --build-arg VITE_API_URL=$VITE_API_URL -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA ./election-frontend
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
    - if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/backend:latest;
        docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/frontend:latest;
        docker push $CI_REGISTRY_IMAGE/backend:latest;
        docker push $CI_REGISTRY_IMAGE/frontend:latest;
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deployment to HIC (Oege)
# To use this, you need to set SSH_USER, SSH_HOST, and SSH_PRIVATE_KEY in GitLab CI/CD Variables
deploy-hic:
  stage: deploy
  image: alpine:latest
  tags:
    - hva
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "Deploying to HIC server (oege.ie.hva.nl)..."
    - |
      if [ -n "$SSH_PRIVATE_KEY" ]; then
        eval $(ssh-agent -s)
        echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
        
        # Create .env file for production on the server
        ssh $SSH_USER@$SSH_HOST "mkdir -p /app"
        ssh $SSH_USER@$SSH_HOST "cat <<EOF > /app/.env
        SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL
        SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME
        SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD
        JWT_SECRET_B64=$JWT_SECRET_B64
        GEMINI_API_KEY=$GEMINI_API_KEY
        CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
        EOF"
        
        # Copy production docker-compose file
        scp docker-compose.prod.yml $SSH_USER@$SSH_HOST:/app/docker-compose.yml
        
        # Log in on registry and restart containers
        ssh $SSH_USER@$SSH_HOST "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY && cd /app && docker compose pull && docker compose up -d"
      else
        echo "SSH_PRIVATE_KEY niet set, overslaan van feitelijke deployment."
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $DEPLOY_HIC == "true"
